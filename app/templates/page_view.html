{% extends "base.html" %}

{% block title %}{{ page.title }} â€” {{ site_name }}{% endblock %}

{% block sidebar_extra %}
<div class="sidebar-section">
  <h3>Page tools</h3>
  <ul>
    {% if user %}
    <li><a href="/wiki/{{ namespace_name }}/{{ page.slug }}/edit">âœï¸ Edit</a></li>
    <li><a href="/wiki/{{ namespace_name }}/{{ page.slug }}/move">ğŸšš Move / Rename</a></li>
    {% endif %}
    <li><a href="/wiki/{{ namespace_name }}/{{ page.slug }}/history">ğŸ“œ History</a></li>
    <li><a href="/api/v1/namespaces/{{ namespace_name }}/pages/{{ page.slug }}/raw">ğŸ“„ Raw source</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <h3>Tools</h3>
  <ul>
    <li><a href="/wiki/{{ namespace_name }}/{{ page.slug }}/print">ğŸ–¨ï¸ Printable version</a></li>
    <li><a href="/special">Special pages</a></li>
    {% if user %}
    <li><a href="/api/v1/namespaces/{{ namespace_name }}/pages/{{ page.slug }}/attachments">ğŸ“ Upload file</a></li>
    {% endif %}
  </ul>
</div>
<div class="sidebar-section">
  <h3>Page info</h3>
  <ul>
    <li><strong>Namespace:</strong> <a href="/wiki/{{ namespace_name }}">{{ namespace_name }}</a></li>
    <li><strong>Format:</strong> <span class="badge badge-{{ ver.format }}">{{ ver.format }}</span></li>
    <li><strong>Version:</strong> {{ ver.version }}</li>
    <li><strong>Author:</strong> {% if ver.author %}<a href="/user/{{ ver.author.username }}">{{ ver.author.username }}</a>{% else %}â€”{% endif %}</li>
    <li><strong>Updated:</strong> {{ ver.created_at.strftime('%Y-%m-%d %H:%M') }}</li>
  </ul>
</div>
{% endblock %}

{% block content %}
{% if viewing_version %}
<div class="version-banner">
  Viewing version {{ viewing_version }} of this page.
  <a href="/wiki/{{ namespace_name }}/{{ page.slug }}">View latest</a>
</div>
{% endif %}

<div class="page-header">
  <h1>{{ page.title }}</h1>
  <div class="page-actions">
    {% if user %}
    <a class="btn btn-primary" href="/wiki/{{ namespace_name }}/{{ page.slug }}/edit">âœï¸ Edit</a>
    <a class="btn" href="/wiki/{{ namespace_name }}/{{ page.slug }}/move">ğŸšš Rename</a>
    {% endif %}
    <a class="btn" href="/wiki/{{ namespace_name }}/{{ page.slug }}/history">ğŸ“œ History</a>
  </div>
</div>

{% if redirected_from %}
<div class="redirect-notice">
  Redirected from <a href="/wiki/{{ namespace_name }}/{{ redirected_from }}?redirect=no">{{ redirected_from }}</a>
</div>
{% endif %}

{% if ver.comment %}
<p class="edit-comment muted"><em>{{ ver.comment }}</em></p>
{% endif %}

<div class="wiki-content">
  {{ rendered | safe }}
</div>

{% if categories and ver.format != 'wikitext' %}
<div class="wiki-categories-bar">
  <strong><a href="/special/categories">Categories:</a></strong>
  {% for cat in categories %}
  <a href="/category/{{ cat }}" class="category-link">{{ cat }}</a>{% if not loop.last %} Â· {% endif %}
  {% endfor %}
</div>
{% endif %}

{% if images %}
<div class="wiki-images">
  <h4 class="wiki-images-title">Images ({{ images|length }})</h4>
  <div class="wiki-images-grid">
    {% for img in images %}
    <div class="wiki-gallery-item">
      <a href="{{ img.url }}" class="lightbox-trigger" data-src="{{ img.url }}" data-caption="{{ img.filename }}">
        <img src="{{ img.url }}" alt="{{ img.filename }}" class="wiki-gallery-thumb" loading="lazy" />
        <span class="wiki-gallery-name">{{ img.filename }}</span>
      </a>
      {% if user %}
      <button class="wiki-gallery-delete" data-filename="{{ img.filename }}"
              data-namespace="{{ namespace_name }}" data-slug="{{ page.slug }}"
              title="Delete {{ img.filename }}" aria-label="Delete">&times;</button>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if images %}
<div id="lightbox-overlay" class="lightbox-overlay" style="display:none;" role="dialog" aria-modal="true">
  <button class="lightbox-close" id="lightbox-close" aria-label="Close">&times;</button>
  <div class="lightbox-inner">
    <img id="lightbox-img" src="" alt="" />
    <p id="lightbox-caption" class="lightbox-caption"></p>
  </div>
</div>
<script>
  const overlay = document.getElementById('lightbox-overlay');
  const lbImg   = document.getElementById('lightbox-img');
  const lbCap   = document.getElementById('lightbox-caption');

  document.querySelectorAll('.wiki-gallery-delete').forEach(btn => {
    btn.addEventListener('click', async e => {
      e.stopPropagation();
      const filename  = btn.dataset.filename;
      const namespace = btn.dataset.namespace;
      const slug      = btn.dataset.slug;
      if (!confirm(`Delete attachment "${filename}"?`)) return;
      try {
        const resp = await fetch(
          `/api/v1/namespaces/${namespace}/pages/${slug}/attachments/${encodeURIComponent(filename)}`,
          { method: 'DELETE', credentials: 'same-origin' }
        );
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          alert(`Delete failed: ${err.detail || resp.statusText}`);
          return;
        }
        const item = btn.closest('.wiki-gallery-item');
        item.remove();
        const grid  = document.querySelector('.wiki-images-grid');
        const remaining = grid.querySelectorAll('.wiki-gallery-item').length;
        const section   = document.querySelector('.wiki-images');
        if (remaining === 0) {
          section.remove();
        } else {
          document.querySelector('.wiki-images-title').textContent = `Images (${remaining})`;
        }
      } catch (err) {
        alert(`Delete failed: ${err.message}`);
      }
    });
  });

  document.querySelectorAll('.lightbox-trigger').forEach(el => {
    el.addEventListener('click', e => {
      e.preventDefault();
      lbImg.src = el.dataset.src;
      lbCap.textContent = el.dataset.caption;
      overlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    });
  });

  document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
  overlay.addEventListener('click', e => { if (e.target === overlay) closeLightbox(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });

  function closeLightbox() {
    overlay.style.display = 'none';
    lbImg.src = '';
    document.body.style.overflow = '';
  }
</script>
{% endif %}
{% endblock %}
