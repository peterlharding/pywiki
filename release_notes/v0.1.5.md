# PyWiki v0.1.5 Release Notes

**Released:** 2026-02-27

---

## Overview

v0.1.5 focuses on wikitext rendering quality. The headline addition is full MediaWiki-compatible table syntax, plus two smaller rendering improvements: external links now open in a new tab, and bare URLs in wikitext are auto-linked. A self-healing render cache ensures existing pages pick up all three changes automatically on first view without any database migration.

---

## New Features

### Wikitext Table Syntax (`{| ... |}`)

Full MediaWiki table syntax is now supported in the wikitext renderer.

**Syntax reference:**

```
{| class="wikitable"
|+ Optional Caption
|-
! Header 1 !! Header 2 !! Header 3
|-
| Cell A || Cell B || Cell C
|-
| style="color:red" | Styled cell || Normal || Normal
|}
```

**Supported features:**
- `{| attrs` — table open with optional HTML attributes (`class=`, `style=`, etc.)
- `|+ caption` — table caption
- `|-` — row separator (with optional row-level attributes)
- `! h1 !! h2` — header cells; inline multi-cell with `!!`
- `| c1 || c2` — data cells; inline multi-cell with `||`
- Per-cell attributes: `| style="color:red" | Cell text`
- `|}` — table close
- Full inline markup inside cells: bold, italic, wikilinks, external links
- Multiple tables per page, freely mixed with paragraphs, headings, and lists
- Tables default to `class="wikitable"` unless an explicit `class=` is provided

**CSS:** `table.wikitable` styles added to `wiki.css` — collapsed borders, padded cells, header background shading, alternating even-row background, caption styling.

### External Links Open in New Tab

All external links in rendered output now include `target="_blank" rel="noopener noreferrer"`. This applies to all three formats (markdown, RST, wikitext) via a post-processing pass at the end of `render()`. Internal wiki links (`/wiki/...`) are unaffected.

### Bare URL Auto-Linking in Wikitext

Raw URLs written without bracket syntax now render as clickable links:

```
https://example.com           → <a href="https://example.com">https://example.com</a>
```

This matches MediaWiki behaviour and complements the existing `[URL]` and `[URL label]` bracketed forms. A lookbehind prevents double-wrapping of URLs already inside `href="..."` attributes or brackets.

---

## Self-Healing Render Cache

A versioned render cache system was introduced to ensure renderer improvements are automatically applied to existing pages.

**How it works:**
- `RENDERER_VERSION = 4` in `renderer.py` — an integer that identifies the current render pipeline
- Every page cached in the `page_versions.rendered` column now starts with `<!--rv:4-->`
- `is_cache_valid(rendered)` checks for this stamp before serving cached HTML
- Any page whose stamp is absent or outdated is silently re-rendered on first view and the new HTML is written back
- No database migration is needed — the cache self-heals page by page

**To invalidate all caches in future** — increment `RENDERER_VERSION`.

---

## Tests

`test_10_wikitext_tables.py` — 21 new tests:

| Test | What it covers |
|---|---|
| `test_table_produces_table_tag` | Basic `<table>` output |
| `test_table_gets_wikitable_class_by_default` | Default `class="wikitable"` |
| `test_table_preserves_explicit_class` | Custom class not overwritten |
| `test_table_preserves_extra_attrs` | `style=` and other attrs pass through |
| `test_table_single_data_cell` | Single `<td>` |
| `test_table_multiple_cells_on_one_row` | Inline `||` multi-cell |
| `test_table_cells_on_separate_lines` | One cell per line |
| `test_table_multiple_rows` | Multiple `|-` row separators |
| `test_table_header_cells` | `!` and `!!` → `<th>` |
| `test_table_header_row_then_data_row` | Mixed header + data rows |
| `test_table_implicit_first_row_without_row_separator` | Header without leading `\|-` |
| `test_table_caption` | `\|+` caption → `<caption>` |
| `test_table_cell_with_attrs` | Per-cell `style=` attribute |
| `test_table_header_with_attrs` | Per-header `colspan=` attribute |
| `test_table_cell_with_bold` | `'''bold'''` inside cell |
| `test_table_cell_with_wikilink` | `[[Page]]` inside cell |
| `test_table_cell_with_external_link` | `[URL label]` inside cell |
| `test_table_preceded_by_paragraph` | Table after paragraph |
| `test_table_followed_by_paragraph` | Table before paragraph |
| `test_multiple_tables_in_same_page` | Two tables in one page |
| `test_table_realistic_example` | Full realistic table with caption, headers, data rows |

**Total: 144 tests** (was 123 at v0.1.4)

---

## Upgrade Notes

No schema changes. No migration required from v0.1.4.

`RENDERER_VERSION` was bumped from 1 → 4 across this and the previous session. Any page with cached HTML from before this version will be transparently re-rendered on first view.

---

## Commit

```
git add -A
git commit -m "v0.1.5: wikitext tables, external link targets, bare URL auto-linking, self-healing cache (144 tests)"
git tag -a v0.1.5 -m "Release v0.1.5"
git push && git push --tags
```
