# PyWiki v0.2.3 Release Notes

**Released:** 2026-02-28

## Highlights

### Auto-generated Table of Contents
Any page with 3 or more headings now automatically shows a **Contents** box
before the first heading — no markup required. Heading anchors (`id=` attributes)
are also added to all headings, enabling deep-linking to any section via `#anchor`.
This works identically across all three content formats: Markdown, RST, and Wikitext.

---

## What's New

### Added

#### Table of Contents (`_add_toc()` post-processor)

The TOC is generated as a post-processing step applied to the rendered HTML,
so it requires no per-format changes and automatically benefits future formats.

**Behaviour:**
- Pages with **≥ 3 headings** get a `<div class="toc">` injected before the first heading
- All `<h1>`–`<h6>` elements receive a unique `id=` attribute for anchor deep-links
- Duplicate heading text is disambiguated with `-1`, `-2`, … suffixes
- Nested headings produce nested `<ol>` lists reflecting document depth
- The threshold is controlled by `TOC_MIN_HEADINGS = 3` (MediaWiki convention)

**Example output structure:**
```html
<div class="toc">
  <div class="toc-title">Contents</div>
  <ol class="toc-list">
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#details">Details</a>
      <ol>
        <li><a href="#sub-topic">Sub Topic</a></li>
      </ol>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ol>
</div>
```

**Format support:**

| Format | Heading syntax | TOC |
|--------|---------------|-----|
| Markdown | `## Heading` | ✅ |
| Wikitext | `== Heading ==` | ✅ |
| RST | `Heading\n=======` | ✅ |

#### CSS (`.toc`, `.toc-title`, `.toc-list`)
Added to `app/static/css/wiki.css`:
- Inline-block box with border, rounded corners, and background fill
- Numbered list style matching MediaWiki's TOC appearance
- Responsive — inherits `--link` and `--border` CSS variables from the theme

#### Tests (`tests/test_13_toc.py`)
21 new tests covering:
- TOC not shown below threshold (< 3 headings)
- TOC shown at exactly 3 headings
- `TOC_MIN_HEADINGS` value assertion
- Heading `id=` attributes assigned
- Duplicate IDs disambiguated
- Inline markup stripped from anchor slugs (`**Bold** Heading` → `bold-heading`)
- "Contents" title present
- TOC links point to correct anchors
- TOC appears before first heading in output
- Nested headings produce nested lists
- Markdown h1/h2/h3 mix
- No-heading pages get no TOC
- Wikitext TOC generated + heading IDs + below-threshold
- RST TOC generated + heading IDs
- Special chars in headings (`C++ & Python`, `Go/Rust`)
- Deep nesting (h2 → h3 → h4 → h5)
- **Total: 193 tests** (was 173 at v0.2.2)

### Changed
- `RENDERER_VERSION` bumped to `7` — all cached rendered HTML invalidated; pages
  re-render automatically on first view, gaining heading anchors and TOC
- `test_03_pages.py` heading assertions updated from `<h1>` to `<h1 id=`

---

## Upgrading from v0.2.2

No database migration or dependency changes required.

Deploy the new code — the render cache self-heals on first page view.
All existing pages will gain TOC and heading anchors automatically.
