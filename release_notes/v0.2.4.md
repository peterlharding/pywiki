# PyWiki v0.2.4 Release Notes

**Released:** 2026-03-01

## Highlights

### Image Upload & Inline Embedding
Pages can now include inline images from their own attachments. Upload images
directly from the editor, then click **Insert** to drop the correct syntax at
the cursor. Images render inline in all three content formats. Attached images
also appear in a gallery at the bottom of every page, with a lightbox for
full-size viewing.

---

## What's New

### Added

#### Wikitext `[[File:]]` embedding

| Syntax | Result |
|--------|--------|
| `[[File:photo.png]]` | Inline `<img>` |
| `[[File:photo.png\|thumb]]` | Floating `<figure>` (right-aligned) |
| `[[File:photo.png\|thumb\|My caption]]` | Figure with caption |
| `[[File:photo.png\|thumb\|left\|Caption]]` | Left-aligned figure |
| `[[File:photo.png\|thumb\|center\|Caption]]` | Centred figure |

- Resolution uses the page's attachment map (filename → URL)
- Missing filenames render as `<span class="missing-file">[[File:...]]</span>`
- Case-insensitive (`[[file:...]]` works)

#### Markdown `attachment:` shorthand

```markdown
![My photo](attachment:photo.png)
```

Resolves to the attachment's full URL at render time. If the filename isn't
found in the attachment map, the tag is left unchanged.

#### RST `.. image::` insert
The **Insert** button on the editor generates:
```rst
.. image:: attachment:photo.png
   :alt: photo.png
```

#### Image upload panel (edit page)
- Drag-and-drop or click-to-browse file picker below the editor
- AJAX upload to `POST /api/v1/namespaces/{ns}/pages/{slug}/attachments`
- Uploaded file appears in the attachment list immediately with a thumbnail
- **Insert** button on each attachment inserts the correct syntax for the
  current format (Markdown / Wikitext / RST) at the cursor position
- Existing attachments shown on page load

#### Image gallery (page view)
- All image attachments (`png`, `jpg`, `jpeg`, `gif`, `webp`, `svg`, `bmp`)
  shown as 96×96 thumbnails below page content
- Gallery only rendered when page has image attachments

#### Lightbox
- Click any gallery thumbnail to view full-size
- Close via `×` button, backdrop click, or `Escape` key
- No external dependencies — pure CSS + vanilla JS

#### CSS (`wiki.css`)
- `.wiki-figure` / `.wiki-thumb` / `.wiki-img` — inline image styles
- `.img-left` / `.img-right` / `.img-center` — alignment helpers
- `.missing-file` — placeholder for unresolved `[[File:]]` references
- `.wiki-images` / `.wiki-images-grid` / `.wiki-gallery-thumb` — gallery
- `.lightbox-overlay` / `.lightbox-inner` / `.lightbox-close` / `.lightbox-caption` — lightbox

#### Tests (`tests/test_14_images.py`)
20 new tests covering:
- `[[File:]]` thumb, no-caption, inline, align-right, align-left
- Missing file placeholder (with and without attachment dict)
- Case-insensitive `[[file:]]`
- `[[File:]]` doesn't break adjacent regular wikilinks
- Multiple `[[File:]]` on same line
- `attachment:` shorthand resolved, missing, no-dict-unchanged, regular URL unaffected, multiple
- No-image-syntax pages unaffected
- `RENDERER_VERSION == 8`
- **Total: 211 tests** (was 193 at v0.2.3)

### Changed
- `render()` signature gains optional `attachments: dict[str, str] | None = None`
- `_render_wikitext()` and `_preprocess_wikilinks_md()` both accept `attachments`
- `RENDERER_VERSION` bumped to `8`
- `view_page` loads attachments before rendering; cache bypassed when attachment map is non-empty
- `edit_page_form` loads attachments for the upload panel
- Version assertions in `test_12` / `test_13` changed to `>= 7` (forward-compatible)

---

## Upgrading from v0.2.3

No database migration or new dependencies required.

Deploy the new code — the render cache self-heals on first page view.
