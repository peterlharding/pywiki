# PyWiki v0.3.0 Release Notes

**Released:** 2026-03-01

## Highlights

### Email Verification
When `REQUIRE_EMAIL_VERIFICATION=true` is set in `.env`, newly registered users receive a verification email before they can log in. Clicking the link in the email marks the account as verified and logs them in automatically. Admins are always exempt from the verification requirement.

### Password Reset
A complete forgot-password / reset-password flow is now available. Users enter their email address at `/forgot-password`, receive a time-limited link (1 hour), and set a new password at `/reset-password`. Email enumeration is prevented — the success message is always shown regardless of whether the email exists.

### Development-friendly email
When `SMTP_HOST` is not configured, all outgoing emails are printed to stdout. No SMTP server is needed during development or testing — tokens appear in the console.

---

## What's New

### Added

#### Email verification (`/verify-email`)
- `REQUIRE_EMAIL_VERIFICATION` setting (default `false`) in `config.py`
- On registration with verification enabled: token generated, email sent, `verify_pending.html` shown
- `GET /verify-email?token=...` validates the token, sets `email_verified=True`, clears the token, and issues session cookies — user is logged in immediately
- Login blocked for unverified accounts when `REQUIRE_EMAIL_VERIFICATION=true` (shows `verify_pending.html`)
- Admins (`is_admin=True`) bypass the verification check

#### Password reset (`/forgot-password`, `/reset-password`)
- `GET /forgot-password` — form to enter email address
- `POST /forgot-password` — generates `reset_token` + `reset_token_expires` (1 hour), sends email; always returns success view
- `GET /reset-password?token=...` — form to enter new password (token pre-filled as hidden field)
- `POST /reset-password` — validates token, checks expiry, hashes new password, clears token; redirects to `/login?reset=1`
- Login page shows "Password reset successfully" banner when `?reset=1` is present
- "Forgot password?" link added to login page

#### Email service (`app/services/email.py`)
- `send_email(to, subject, body_text, body_html)` — sends via `aiosmtplib`; falls back to stdout when unconfigured
- `send_verification_email(to, username, token)` — plain text + HTML bodies
- `send_password_reset_email(to, username, token)` — plain text + HTML bodies

#### SMTP configuration (all in `.env` / environment)
| Variable | Default | Description |
|----------|---------|-------------|
| `SMTP_HOST` | `""` | SMTP server hostname (empty = stdout mode) |
| `SMTP_PORT` | `587` | Port (587 = STARTTLS, 465 = implicit TLS) |
| `SMTP_USER` | `""` | Login username |
| `SMTP_PASSWORD` | `""` | Login password |
| `SMTP_FROM` | `noreply@example.com` | From address |
| `SMTP_TLS` | `true` | STARTTLS on connect |
| `SMTP_SSL` | `false` | Implicit TLS (port 465) |
| `REQUIRE_EMAIL_VERIFICATION` | `false` | Block login until email verified |

#### Database
- 4 new `users` columns: `email_verified` (bool), `verification_token` (str), `reset_token` (str), `reset_token_expires` (datetime)
- Alembic migration `a1b2c3d4e5f6` — run `alembic upgrade head`

#### New dependency
- `aiosmtplib>=3.0.0` added to `pyproject.toml`

### Fixed
- Alembic FTS migration (`58579c489d29`) failed on fresh installs with `InvalidRequestError: isolation_level may not be altered` — fixed by using `op.get_context().autocommit_block()` instead of `conn.execution_options(isolation_level="AUTOCOMMIT")`

### Tests
- `tests/test_15_email.py` — 17 new tests covering:
  - Email service unit tests (stdout fallback)
  - Token generation / verification / expiry helpers
  - UI routes (form rendering, password mismatch, bad token)
  - Full end-to-end: register → verify → logged in
  - Full end-to-end: register → forgot password → reset → login with new password
- **237 tests total** (was 220 at v0.2.5)

---

## Upgrading from v0.2.5

```bash
alembic upgrade head
```

No new Python packages to install unless you are running from source — `aiosmtplib` is now a declared dependency.

**Email verification is opt-in** — existing installs are unaffected. Set `REQUIRE_EMAIL_VERIFICATION=true` only when SMTP is configured.
