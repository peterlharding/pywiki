# PyWiki v0.4.0 Release Notes

**Released:** 2026-03-02

## Highlights

### Macro framework — TOC is now opt-in

The Table of Contents is no longer injected automatically when a page has 3 or
more headings. Instead, place `{{toc}}` or `__TOC__` anywhere in the page
content to insert it at that exact position.

This gives authors full control: no TOC on short reference pages, TOC mid-page
after an introduction, or TOC at the very top — all supported.

---

## What's New

### `{{toc}}` macro (all formats)

Place `{{toc}}` anywhere in Markdown, RST, or Wikitext content:

```markdown
{{toc}}

## Introduction

Lorem ipsum...

## Details
```

Case-insensitive: `{{toc}}`, `{{TOC}}`, `{{ Toc }}` all work.

### `__TOC__` MediaWiki magic word (all formats)

For MediaWiki compatibility — primarily useful in Wikitext pages but also
works in Markdown and RST:

```wikitext
__TOC__

== Section One ==

== Section Two ==
```

### Heading anchor IDs are always generated

Even without a TOC macro, all `h1`–`h6` headings still receive `id=`
attributes for deep-linking (e.g. `#introduction`). The macro only controls
whether the `<div class="toc">` block is rendered.

### Sentinel-based insertion

Macros are replaced with `<!--PYWIKI-TOC-PLACEHOLDER-->` before
format-specific rendering. The TOC block is injected at the exact sentinel
position in the final HTML. RST (docutils) HTML-escapes HTML comments, so the
post-processor also detects the escaped form inside `<p>` tags.

---

## Breaking change

**Existing pages with 3+ headings will no longer show a TOC automatically.**

To restore a TOC, add `{{toc}}` at the desired position in the page content.
The home page (`main-page`) and any other pages that previously showed a TOC
will need to be updated manually.

No database migration is required. `RENDERER_VERSION` has been bumped to 9,
so all cached HTML is automatically invalidated on the next page load.

---

## Tests

- `tests/test_13_toc.py` fully updated — 30 tests covering opt-in behaviour,
  `{{toc}}`, `__TOC__`, position control, nesting, all three formats, and edge
  cases
- **247 tests total** (was 237 at v0.3.0)

---

## Upgrading from v0.3.x

No migrations required. Restart the app — cached HTML is invalidated
automatically by the `RENDERER_VERSION` bump.

Add `{{toc}}` to any pages where you want a Table of Contents.
