# PyWiki v0.5.1 — Release Notes

**Released:** 2026-03-02


## Summary

v0.5.1 is a bug-fix release focused on RST rendering correctness and attachment image
reliability. All fixes are backwards-compatible; no database migrations are required.


## Bug Fixes

### RST headings silently stripped
The first `===` heading in an RST page was being promoted to the document *title* and the
first `---` heading to the document *subtitle* by docutils' `doctitle_xform` feature.
Both were excluded from `parts["body"]` (the section PyWiki renders) and silently dropped,
so the top one or two headings simply never appeared on the page.

**Fix:** `doctitle_xform=False` and `sectsubtitle_xform=False` set in `_render_rst()`.
All headings now render as normal `<h2>`, `<h3>` etc. regardless of underline character.

### Page creation lost on RST render error
If docutils raised an exception while rendering RST content (e.g. malformed syntax), the
SQLAlchemy session middleware called `session.rollback()`, silently discarding the newly
saved page. The redirect then pointed at a slug that no longer existed — appearing as a
"Page Not Found" error even though the user had just created the page.

**Fix:** `render_markup()` is now called in a separate `try/except Exception` block outside
the DB transaction. A render failure leaves `ver.rendered = None`; the page is still saved
and will be rendered fresh on first view.

### Attachment images broken after save
When saving an edit, `edit_page_submit` and `create_page_submit` called `render_markup()`
without passing the page's attachment map. `attachment:filename` directives were not
resolved to real URLs, so the cached render contained broken `<img src="">` attributes.
Subsequent page views served this broken cached HTML.

**Fix:** Both save routes now load `att_map` from the database before rendering.

### Page view never cached renders for pages with attachments
The cache-write guard `if version is None and not att_map` prevented rendered HTML from
ever being stored when a page had attachments, causing a full re-render on every page view.
Since attachment URLs are resolved at render time using the stable `BASE_URL`, they do not
need to be excluded from caching.

**Fix:** Condition relaxed to `if version is None`.


## New Features

### Image delete button
A red × button now appears on each image thumbnail in the page gallery when hovering
(logged-in users only). Clicking it calls the DELETE API and removes the item from the
DOM immediately without a page reload. The gallery section is hidden automatically when
the last image is deleted.


## Renderer Changes

- `RENDERER_VERSION` bumped from `9` → `11` — all stale cached HTML is automatically
  discarded and re-rendered on next page view (no manual intervention needed).
- CSS links now include a `?v={{ app_version }}` cache-buster to force browsers to reload
  the stylesheet after a deploy.
- Wikitext `<figure>` elements are no longer wrapped in `<p>` tags.
- Float layout fixes: clearfix on `.wiki-content`, `clear: both` on headings and category
  bars to prevent floated images overlapping subsequent content.


## Upgrade Instructions

No database migrations required.

```bash
cd /opt/pywiki
git pull
systemctl stop pywiki
pip install -r deploy/requirements.txt
systemctl start pywiki
```
